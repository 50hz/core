<!--

The `fin-hypergrid-behavior-json` element is a custom Polymer web component used to support the openfin [fin-hypergrid](http://github.com/openfin/fin-hypergrid) component.

@group OpenFin hypergrid
@element fin-hypergrid-behavior-json
@homepage http://github.com/openfin/fin-hypergrid
-->

<polymer-element name="fin-hypergrid-behavior-json" extends="fin-hypergrid-behavior-default">
  <template></template>
  <script>

/*jshint  bitwise: false */
'use strict';

var quickSort = function(arr, key) {

  // return if array is unsortable
  if (arr.length <= 1){
    return arr;
  }

  var less = Array(), greater = Array();

  // select and remove a pivot value pivot from array
  // a pivot value closer to median of the dataset may result in better performance
  var pivotIndex = Math.floor(arr.length / 2);
  var pivot = arr.splice(pivotIndex, 1)[0];

  // step through all array elements
  for (var x = 0; x < arr.length; x++){

    // if (current value is less than pivot),
    // OR if (current value is the same as pivot AND this index is less than the index of the pivot in the original array)
    // then push onto end of less array
    if (
      (
        !key  // no object property name passed
        &&
        (
          (arr[x] < pivot)
          ||
          (arr[x] == pivot && x < pivotIndex)  // this maintains the original order of values equal to the pivot
        )
      )
      ||
      (
        key  // object property name passed
        &&
        (
          (arr[x][key] < pivot[key])
          ||
          (arr[x][key] == pivot[key] && x < pivotIndex)  // this maintains the original order of values equal to the pivot
        )
      )
    ){
      less.push(arr[x]);
    }

    // if (current value is greater than pivot),
    // OR if (current value is the same as pivot AND this index is greater than or equal to the index of the pivot in the original array)
    // then push onto end of greater array
    else {
      greater.push(arr[x]);
    }
  }

  // concatenate less+pivot+greater arrays
  return quickSort(less, key).concat([pivot], quickSort(greater, key));
};

(function() {

    Polymer({ /* jslint ignore:line */

        sorted: {},
        sortStates: [' ', ' ^', ' v'],
        data: [],
        headers: [],
        fields: [],

        setHeaders: function(headerLabels) {
            this.headers = headerLabels;
        },

        setFields: function(fieldNames) {
            this.fields = fieldNames;
        },

        setData: function(jsonData) {
            this.data = jsonData;
            this.changed();
        },

        getValue: function(x, y) {
            return this.data[y][this.fields[x]];
        },

        setValue: function(x, y, value) {
            this.data[y][this.fields[x]] = value;
        },

        getFixedColValue: function(x, y) {
            return y;
        },

        getFixedRowValue: function(x, y) {
            var sortIndex = this.sorted[x] || 0;
            return this.headers[x] + this.sortStates[sortIndex];
        },

        getFixedColCount: function() {
            return 1;
        },

        getRowCount: function() {
            return this.data.length;
        },

        getColCount: function() {
            return this.fields.length;
        },

        fixedRowClicked: function(grid, mouse) {
            var colIndex = this.scrollPositionX + mouse.cell.x - this.getFixedColCount();
            this.toggleSort(colIndex);
        },

        toggleSort: function(colIndex) {
            this.grid.clearSelections();
            if (colIndex >= this.fields.length) {
                return;
            }
            var current = this.sorted[colIndex] || 0;
            var stateCount = this.sortStates.length;
            var sortStateIndex = (current + 1) % stateCount;

            for (var i = 0; i < this.fields.length; i++) {
                this.sorted[i] = 0;
            }

            this.sorted[colIndex] = sortStateIndex;


            var colName = this.fields[colIndex];
            if (sortStateIndex === 0) {

            } else if (sortStateIndex === 1) {
                this.data = quickSort(this.data, colName);
            } else {
                this.data = this.data.reverse();
            }
            this.changed();
        }

    });

})(); /* jslint ignore:line */

  </script>
</polymer-element>
