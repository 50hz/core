<!--

The `fin-hypergrid-behavior-json` element is a custom Polymer web component used to support the openfin [fin-hypergrid](http://github.com/openfin/fin-hypergrid) component.

@group OpenFin hypergrid
@element fin-hypergrid-behavior-json
@homepage http://github.com/openfin/fin-hypergrid
-->

<polymer-element name="fin-hypergrid-behavior-json" extends="fin-hypergrid-behavior-default">
  <template></template>
  <script>

/*jshint  bitwise: false */
'use strict';

(function() {

    Polymer({ /* jslint ignore:line */

        sorted: {},
        sortStates: [' ', ' ^', ' v'],
        dataIndexes: [],
        data: [],
        headers: [],
        fields: [],

        setHeaders: function(headerLabels) {
            this.headers = headerLabels;
        },

        setFields: function(fieldNames) {
            this.fields = fieldNames;
        },

        setData: function(jsonData) {
            this.data = jsonData;
            this.initDataIndexes();
            this.changed();
        },

        initDataIndexes: function() {
            //initialize the indexe cache
            for (var i = 0; i < this.data.length; i++) {
                this.data[i].__si = i;
                this.data[i].__i = i;
            }
        },

        getValue: function(x, y) {
            return this.data[y][this.fields[x]];
        },

        setValue: function(x, y, value) {
            this.data[y][this.fields[x]] = value;
        },

        getFixedRowValue: function(x, y) {
            var sortIndex = this.sorted[x] || 0;
            return this.headers[x] + this.sortStates[sortIndex];
        },

        getFixedColCount: function() {
            return 1;
        },

        getRowCount: function() {
            return this.data.length;
        },

        getColCount: function() {
            return this.fields.length;
        },

        fixedRowClicked: function(grid, mouse) {
            var colIndex = this.scrollPositionX + mouse.gridCell.x - this.getFixedColCount();
            this.toggleSort(colIndex);
        },

        toggleSort: function(colIndex) {
            this.grid.clearSelections();
            if (colIndex >= this.fields.length) {
                return;
            }
            var current = this.sorted[colIndex] || 0;
            var stateCount = this.sortStates.length;
            var sortStateIndex = (current + 1) % stateCount;
            for (var i = 0; i < this.fields.length; i++) {
                this.sorted[i] = 0;
            }
            this.sorted[colIndex] = sortStateIndex;
            var colName = this.fields[colIndex];
            if (sortStateIndex === 0) {
                var newData = new Array(this.data.length);
                for (var i = 0; i < this.data.length; i++) {
                    var each = this.data[i];
                    newData[each.__si] = each;
                }
                this.data = newData;
            } else if (sortStateIndex === 1) {
                this.data.sort(function (a, b) {
                  if (a[colName] === b[colName])
                    return a.__i - b.__i;
                  if (a[colName] < b[colName])
                    return -1;
                  return 1;
                });
            } else {
                this.data = this.data.reverse();
            }
            for (var i = 0; i < this.data.length; i++) {
                this.data[i].__i = i;
            }
            this.changed();
        }

    });

})(); /* jslint ignore:line */

  </script>
</polymer-element>
