<!doctype html>
<html>
<head>
  <title>fin-hypergrid Demo</title>
  <script src="accounting.min.js"></script>
  <script src="sampledata.js"></script>
  <script src="myThemes.js"></script>
<!--   <link rel="import" href="fin-hypergrid.min.html"> -->
  <link rel="import" href="../../polymer/html/fin-hypergrid.html">
  <style>
    .abs {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
  </style>
</head>
<body>

<fin-hypergrid class="abs" id="json-example">
    <fin-hypergrid-behavior-json></fin-hypergrid-behavior-json>
</fin-hypergrid>

<script>

(function(){
    //used by the cellProvider, return null for a column if you want no editor to pop up
    var editorTypes = [null,'textfield','spinner','date','choice','choice','choice','textfield','textfield','textfield'];
    var filterTypes = ['choice','textfield','choice','textfield','choice','textfield','choice','textfield','choice','textfield'];

    document.addEventListener('polymer-ready', function() {

        //get ahold of our json grid example
        var jsonGrid = document.querySelector('#json-example');

        jsonGrid.setColumnProperties(2, {
            backgroundColor: 'maroon',
            color: 'pink'
        });

        //get it's table model
        var jsonModel = jsonGrid.getBehavior();

        //get the cell cellProvider for altering cell renderers
        var cellProvider = jsonModel.getCellProvider();

        //set the actual json row objects
        jsonModel.setData(people); //see sampledata.js for the random data

        //make the first col fixed;
        jsonModel.setFixedColumnCount(2);
        jsonModel.setFixedRowCount(2);

        jsonModel.setHeaderColumnCount(1);
        jsonModel.setHeaderRowCount(2);

        //lets set 2 rows of totals
        var totals =
            [['','','','','','','','','','',''],
            ['','1st',251,'XXXX-XX-XX','1 of 50','1 of 50','T/F','$$$$$','£££££','computed col','']];

        jsonModel.setTotals(totals);

        //sort ascending on the first column (first name)
        //jsonModel.toggleSort(0);

        //all formatting and rendering per cell can be overridden in here
        cellProvider.getCell = function(config) {
            var renderer = cellProvider.cellCache.simpleCellRenderer;
            config.halign = 'left';
            var x = config.x;
            var y = config.y;

            if ((y % 3) === 0){
                config.backgroundColor = '#E87200';
                config.font = 'italic 15px Arial';
            } else if (((y - 1) % 3) === 0){
                config.backgroundColor = '#aaaaff';
                config.color = '#ffffff';
            }
            if (x === 1) {
                renderer = cellProvider.cellCache.linkCellRenderer;
            } else if (x === 2) {
                config.halign = 'center';
            } else if (x === 3) {
                config.halign = 'center';
            } else if (x === 6) {
                renderer = cellProvider.cellCache.buttonRenderer;
            } else if (x === 7) {
                var travel = 60 + Math.round(config.value*150/100000);
                var bcolor = travel.toString(16);
                config.halign = 'right';
                config.backgroundColor = '#00' + bcolor + '00';
                config.color = '#FFFFFF';
                config.value = accounting.formatMoney(config.value);
            } else if (x === 8) {
                var travel = 105 + Math.round(config.value*150/1000);
                var bcolor = travel.toString(16);
                config.halign = 'right';
                config.backgroundColor = '#' + bcolor+ '0000';
                config.color = '#FFFFFF';
                config.value = accounting.formatMoney(config.value, "€", 2, ".", ",");
            }
            return renderer;
        };

        //lets override the cell editors, and configure the drop down lists
        jsonModel.getBaseModel().getCellEditorAt = function(x, y) {
            var type = editorTypes[x];
            var cellEditor = this.grid.cellEditors[type];
            if (y === 1) {
                var type = filterTypes[x];
                cellEditor = this.grid.cellEditors[type];
                if (type === 'choice') {
                    cellEditor.items = ['','one', 'two', 'three'];
                }
                return cellEditor;
            }
            if (x === 0) {
                cellEditor.items = lastNames;
            } else if (x === 4 || x === 5) {
                cellEditor.items = states;
            } else if (x === 6) {
                cellEditor.items = [true, false];
            } else if (x === 2) {
                cellEditor.input.setAttribute('min', 0);
                cellEditor.input.setAttribute('max', 10);
                cellEditor.input.setAttribute('step', 0.01);
            }
            return cellEditor;
        };

        jsonModel.getCursorAt = function(x,y) {
            if (x === 1) {
                return 'pointer'
            } else {
                return null;
            }
        };

        jsonGrid.addFinEventListener('fin-selection-changed', function(e){
            console.log(jsonGrid.getSelectedRows(), jsonGrid.getSelectedColumns());
        });

        jsonGrid.addFinEventListener('fin-double-click', function(e){
            var cell = e.detail.gridCell;
            if(cell.y === 0) {
                jsonGrid.toggleSort(cell.x);
            } else if (cell.y === 1) { //filter row
                jsonGrid.activateEditor(cell.x, cell.y);
            } else {
                var rowContext = jsonModel.getRow(cell.y);
                console.log('fin-double-click row-context:',rowContext);
            }
        });

        jsonGrid.addFinEventListener('fin-click', function(e){
            var headerColCount = jsonGrid.getHeaderColumnCount();
            var headerRowCount = jsonGrid.getHeaderRowCount();
            var cell = e.detail.gridCell;
            if(cell.y === 0 && cell.x >= headerColCount) {
                jsonGrid.toggleSelectColumn(cell.x, e.detail.keys);
            } else if(cell.x === 0 && cell.y >= headerRowCount) {
                jsonGrid.toggleSelectRow(cell.y, e.detail.keys);
            }
        });

        jsonGrid.addFinEventListener('fin-scroll-x', function(e){
            console.log('fin-scroll-x ', e.detail.value);
        });

        jsonGrid.addFinEventListener('fin-scroll-y', function(e){
            console.log('fin-scroll-y', e.detail.value);
        });

        jsonGrid.addProperties({
            readOnly: false
        });

        jsonGrid.addFinEventListener('fin-request-cell-edit', function(e) {
            console.log('fin-request-cell-edit', e);
            //e.preventDefault(); //uncomment to cancel editor popping up
        });

        jsonGrid.addFinEventListener('fin-before-cell-edit', function(e) {
            console.log('fin-before-cell-edit', e);
            //e.preventDefault(); //uncomment to cancel editor popping up
        });

        jsonGrid.addFinEventListener('fin-after-cell-edit', function(e) {
            console.log('fin-after-cell-edit', e);
        });

        jsonGrid.addFinEventListener('fin-cell-enter', function(e) {
            var cell = e.detail.gridCell;
            console.log('fin-cell-enter', cell.x, cell.y);
            jsonGrid.setAttribute('title', 'fin-cell-enter(' + cell.x +', '+ cell.y+')');
        });

        jsonGrid.addFinEventListener('fin-set-totals-value', function(e) {
            var details = e.detail;
            var x = details.x;
            var y = details.y;
            var value = details.value;
            jsonModel.getBaseModel().getTotals()[0][x] = value;
            console.log('filter on ' + value + ' for column' + jsonModel.getBaseModel().getHeaders()[x]);
            jsonGrid.repaint();
        });

        jsonGrid.addFinEventListener('fin-keydown', function(e) {
            var key = e.detail.char;
            if (key === 'RETURN') {
                //move the cursor one space to the right
                jsonGrid.moveSingleSelect(1,0);
            } else if (key === 'TAB') {
                //select the bottom right most cell and scroll there
                jsonGrid.selectCell(jsonGrid.getColumnCount()-1, jsonGrid.getRowCount()-1);
                jsonGrid.scrollBy(jsonGrid.getColumnCount(), jsonGrid.getRowCount());
            }
            console.log(e);
        });

        jsonGrid.addFinEventListener('fin-row-selection-changed', function(e) {
            console.log('fin-row-selection-changed', e.detail);
        });

        jsonGrid.addFinEventListener('fin-column-selection-changed', function(e) {
            console.log('fin-column-selection-changed', e.detail);
        });

        jsonGrid.addFinEventListener('fin-editor-data-change', function(e) {
            console.log('fin-editor-data-change', e.detail);
        });

        jsonGrid.addFinEventListener('fin-editor-key-up', function(e) {
            console.log('fin-editor-key-up', e.detail);
        });

        jsonGrid.addFinEventListener('fin-editor-key-press', function(e) {
            console.log('fin-editor-key-press', e.detail);
        });

        jsonGrid.addFinEventListener('fin-editor-key-down', function(e) {
            console.log('fin-editor-key-down', e.detail);
        });

        jsonGrid.addFinEventListener('fin-context-menu', function(e) {
            var modelPoint = e.detail.gridCell;
            console.log('fin-context-menu(' + modelPoint.x + ', ' + (modelPoint.y - 3) + ')');
        });

        var fields = jsonModel.getFields();
        var headers = jsonModel. getHeaders();

        console.log(headers);
        console.log(fields);

        jsonModel.setCellProperties(1, 0, {
            font: '10pt Tahoma',
            color: 'red',
            backgroundColor: 'lightblue'
        });

        setTimeout(function() {

            jsonModel.setFields(["employed", "income", "travel", "squareOfIncome"]);
            jsonModel.setHeaders(["one", "two", "three", "four"]);

            console.log(jsonModel.getHeaders());
            console.log(jsonModel.getFields());

            console.log('visible rows = ' + jsonGrid.getVisibleRows());
            console.log('visible columns = ' + jsonGrid.getVisibleColumns());


            setTimeout(function() {

                jsonModel.setFields(fields);
                jsonModel.setHeaders(headers);

                console.log('mapping between indexes and column names');
                var fieldsMap = {};
                for (var i = 0; i < fields.length; i++) {
                    fieldsMap[fields[i]] = i;
                    console.log(i + ' <> ' + fields[i]);
                }

                var toI = function(fieldName){
                    return fieldsMap[fieldName];
                };

                var toIs = function(arrayOfFieldNames) {
                    return arrayOfFieldNames.map(toI);
                };

                var state = {
                        columnIndexes: toIs([
                            "last_name",
                            "pets",
                            "first_name",
                            "birthDate",
                            "birthState",
                            "residenceState",
                            "employed",
                            "income",
                            "travel",
                            "squareOfIncome"]),
                        rowHeights:{ 0: 30 },
                        fixedColumnCount:1,
                        fixedRowCount:3,
                        headerColumnCount:0,
                        headerRowCount:3,
                        columnAutosizing:true
                    };

                jsonGrid.setState(state);

                jsonGrid.addProperties({
                    scrollbarHoverOff: 'visible',
                    scrollbarHoverOver: 'visible',
                    editable: true
                });

                // properties that can be set
                // use a function or a value

                // font
                // color
                // backgroundColor
                // foregroundSelectionColor
                // backgroundSelectionColor

                // columnHeaderFont
                // columnHeaderColor
                // columnHeaderBackgroundColor
                // columnHeaderForegroundSelectionColor
                // columnHeaderBackgroundSelectionColor

                // rowHeaderFont
                // rowHeaderColor
                // rowHeaderBackgroundColor
                // rowHeaderForegroundSelectionColor
                // rowHeaderBackgroundSelectionColor

                var filterProperties = {
                    backgroundColor: 'white'
                };

                for (var i = 0; i < headers.length; i++) {
                    jsonModel.setCellProperties(i,1,filterProperties);
                };

                jsonModel.setCellProperties(2,0,
                    {
                        font: '10pt Tahoma',
                        color: 'red',
                        backgroundColor: 'lightblue'
                    });

                jsonModel.setColumnProperties(1,
                    {
                        backgroundColor: function(config) {
                            if (config.value[0] === 'S') {
                                return 'purple';
                            } else {
                                return config.backgroundColor;
                            }
                        },
                        columnHeaderBackgroundColor: '#142B6F', //dark blue
                        columnHeaderColor: 'white'
                    });

                console.log(jsonModel.getHeaders());
                console.log(jsonModel.getFields());

                console.log('visible rows = ' + jsonGrid.getVisibleRows());
                console.log('visible columns = ' + jsonGrid.getVisibleColumns());

                //see myThemes.js file for how to create a theme
                //jsonGrid.addProperties(myThemes.one);
                //jsonGrid.addProperties(myThemes.two);
                //jsonGrid.addProperties(myThemes.three);


            }, 2000);



        }, 2000);


    });
})();

</script>

</body>
</html>
