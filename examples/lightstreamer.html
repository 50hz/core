<html>
<head>
  <script src="http://demos.lightstreamer.com/commons/noloadamd.js"></script>
  <script src="http://demos.lightstreamer.com/commons/lightstreamer.js"></script>
  <link rel="import" href="../fin-hypergrid.min.html">
<style>
::-webkit-scrollbar {
    -webkit-appearance: none;
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-thumb {
    border-radius: 4px;
    background-color: rgba(0,0,0,.5);
    -webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);
}
 html {
    overflow: scroll;
}
 body {
    margin: 0;
    padding: 0;
 }
 #stock-grid {
    top: 10px;
    bottom: 50px;
    right: 10px;
    left: 10px;
    position: absolute;
 }
 #buy-grid {
    top: 50px;
    bottom: 10px;
    right: 50%;
    left: 10px;
    position: absolute;
 }
 #sell-grid {
    top: 50px;
    bottom: 10px;
    right: 10px;
    left: 50%;
    position: absolute;
 }
</style>
</head>
<body>
    <fin-hypergrid id="stock-grid">
        <fin-hypergrid-behavior-json></fin-hypergrid-behavior-json>
    </fin-hypergrid>
    <fin-hypergrid id="buy-grid">
        <fin-hypergrid-behavior-json></fin-hypergrid-behavior-json>
    </fin-hypergrid>
    <fin-hypergrid id="sell-grid">
        <fin-hypergrid-behavior-json></fin-hypergrid-behavior-json>
    </fin-hypergrid>
<script>


    function MarketDepthGrid(grid,sortConf,columns) {
        this.map = {};

        //get ahold of our json grid example
        var jsonGrid = document.querySelector(grid);


        //get it's table model
        this.jsonModel = jsonGrid.getBehavior();

        this.emptyState = {
            columnIndexes:[0,1],
            fixedColumnIndexes:[],
            hiddenColumns: [],
            columnWidths: [52,69],
            fixedColumnWidths: [],
            rowHeights: {},
            fixedRowHeights: {},
            sorted: []
          };

        this.sortedState = {};
        for (var i in this.emptyState) {
            this.sortedState[i] = this.emptyState[i];
        }
        this.sortedState.sorted = sortConf;

        this.jsonModel.setState(this.emptyState);

        this.jsonModel.setColumns(columns);

        //set the actual json row objects
        this.jsonModel.setData([]);

        //make the first row fixed;
        this.jsonModel.setFixedRowCount(1);

      };

      MarketDepthGrid.prototype = {

          onEndOfSnapshot: function() {
            this.jsonModel.setState(this.sortedState);
            this.jsonModel.dataModified();
          },

          onItemUpdate: function(itemUpdate) {
              var command = itemUpdate.getValue("command");
              var key = Number(itemUpdate.getValue("key")); //make it anumber to help the sort
              var qty = Number(itemUpdate.getValue("qty"));
              switch(command) {
                  case "UPDATE":
                    if (this.map[key]) {
                      this.map[key].qty = qty;
                      this.jsonModel.changed();
                      break;
                    }
                    //else should not happen, let's do the ADD anyway
                  case "ADD":
                    this.map[key] = {key: key, qty: qty};
                    this.jsonModel.data.push(this.map[key]);
                    this.jsonModel.dataModified();
                    break;

                  case "DELETE":
                    var index = this.jsonModel.data.indexOf(this.map[key]);
                    if (index > -1) {
                        this.jsonModel.data.splice(index,1);
                    } //else ??
                    delete(this.map[key]);
                    this.jsonModel.dataModified();
                    break;
              };

          },

          onSubscription: function() {
            this.jsonModel.setData([]); //reset data
            this.jsonModel.setState(this.emptyState); //disable sorting while receiving the snapshot
          },

          onClearSnapshot: function(itemName,itemPos) {
            this.jsonModel.setData([]); //reset data
          }
      };


    //setup random data for the JSON tab example
    (function(){

        var STOCK = "SF_TECH";
        //STOCK = "OS_C"; //slow item for testing purposes

        document.addEventListener('polymer-ready', function() {

            var stockGrid = document.querySelector("#stock-grid");
            var stockModel = stockGrid.getBehavior();
            stockModel.setColumns([
              { title: 'Stock Name', field: 'short_description' },
              { title: 'Status', field: 'trading_phase' },
              { title: 'Reference Price', field: 'reference_price' },
              { title: 'Last', field: 'last' },
              { title: 'Last Price', field: 'last_price' },
              { title: 'Last Quantity', field: 'last_qty' }
            ]);
            stockModel.setFixedRowCount(1);
            stockModel.setData([{
                short_description: "",
                reference_price: "",
                last: "",
                last_price: "",
                last_qty: ""
            }]);


            var qtyColumn = { title: 'Quantity', field: 'qty' };
            var priceColumn = { title: 'Price', field: 'key' };

            var buy = new MarketDepthGrid('#buy-grid',[0,2],[qtyColumn,priceColumn]);
            var sell = new MarketDepthGrid('#sell-grid',[1,0],[priceColumn,qtyColumn]);


            require(["LightstreamerClient","Subscription"], function(LightstreamerClient,Subscription) {


                var client = new LightstreamerClient("https://push.lightstreamer.com","MARKETDEPTH");
                client.addListener({
                    container: document.getElementById("ls-status"),
                    onStatusChange: function(newStatus) {
                        switch(newStatus) {
                            case "CONNECTING":
                            case "CONNECTED:STREAM-SENSE":
                                this.container.textContent = "connecting";
                                break;
                            case "DISCONNECTED":
                            case "DISCONNECTED:WILL-RETRY":
                                this.container.textContent = "disconnected";
                                break;
                            case "CONNECTED:WS-STREAMING":
                            case "CONNECTED:HTTP-STREAMING":
                            case "CONNECTED:WS-POLLING":
                            case "CONNECTED:HTTP-POLLING":
                                this.container.textContent = "connected";
                                break;
                        }
                    }
                });
                client.connect();

                var buySubscription = new Subscription("COMMAND",STOCK+"_BUYSIDE",["command", "key", "qty"]);
                buySubscription.setRequestedSnapshot("yes");
                buySubscription.addListener(buy);
                buySubscription.addListener({
                     onItemLostUpdates: function () {
                         // Unsubcribe and then subscribe again the Item in order that the snapshot restore the list.
                         client.unsubscribe(buySubscription);
                         client.subscribe(buySubscription);
                     }
                 });

                var sellSubscription = new Subscription("COMMAND",STOCK+"_SELLSIDE",["command", "key", "qty"]);
                sellSubscription.setRequestedSnapshot("yes");
                sellSubscription.addListener(sell);
                sellSubscription.addListener({
                     onItemLostUpdates: function () {
                         // Unsubcribe and then subscribe again the Item in order that the snapshot restore the list.
                         client.unsubscribe(sellSubscription);
                         client.subscribe(sellSubscription);
                     }
                 });

                var stockSubscription = new Subscription("MERGE",STOCK,["short_description","reference_price","last","last_price","last_qty","trading_phase"])
                stockSubscription.setRequestedSnapshot("yes");
                stockSubscription.addListener({
                   onItemUpdate: function(itemUpdate) {
                       itemUpdate.forEachChangedField(function(name,pos,value) {
                           stockModel.data[0][name] = value;
                           stockModel.changed();
                       });
                   }
                });



                client.subscribe(buySubscription);
                client.subscribe(sellSubscription);
                client.subscribe(stockSubscription);
            });

        });

    })();

</script>
</body>
</html>
